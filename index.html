<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Certificate</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- pdf-lib (UMD) & fontkit (UMD) -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@0.0.4/dist/fontkit.umd.js"></script>

    <!-- Day.js + Plugin สำหรับ parse -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/en.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/buddhistEra.js"></script>
    <script>
      [dayjs_plugin_customParseFormat, dayjs_plugin_buddhistEra].forEach(
        dayjs.extend
      );
      dayjs.locale("th"); // ตั้งค่า locale เป็นไทย
    </script>
  </head>
  <body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
    <header class="border-b bg-white">
      <div
        class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between"
      >
        <h1 class="text-lg font-semibold">Certificate Preview</h1>
        <span class="text-xs text-gray-500">Minimal • Client-only</span>
      </div>
    </header>

    <main class="flex-grow max-w-4xl mx-auto px-4 py-6 space-y-4">
      <!-- Controls Card -->
      <section class="bg-white rounded-2xl shadow p-4 md:p-6">
        <div
          class="flex flex-col gap-3 sm:gap-4 sm:flex-row sm:items-start sm:justify-between"
        >
          <!-- Info -->
          <div class="min-w-0 space-y-1">
            <div class="text-xs sm:text-sm text-gray-500">สำหรับชื่อ</div>
            <div
              id="displayName"
              class="text-xl sm:text-2xl font-semibold truncate"
            >
              Guest
            </div>

            <div class="text-[11px] sm:text-xs text-gray-500">
              เปลี่ยนชื่อผ่าน URL เช่น
              <a
                id="exampleLink"
                href="#"
                class="align-middle underline decoration-dotted hover:decoration-solid text-blue-700 hover:text-blue-900"
              >
                <code
                  >?name=สมชาย%20ใจดี&event=การอบรมสร้างเกียรติบัตร&date=2025-01-01</code
                >
              </a>
              <button
                id="copyLinkBtn"
                type="button"
                class="ml-2 inline-flex items-center rounded-lg px-2 py-1 border border-gray-300 text-[11px] sm:text-xs hover:bg-gray-50"
              >
                คัดลอกลิงก์
              </button>
            </div>
          </div>

          <!-- Actions -->
          <div
            class="flex flex-col sm:flex-row sm:flex-wrap items-stretch sm:items-center gap-2 sm:gap-2 sm:justify-end"
          >
            <button
              id="generateBtn"
              class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2 min-h-[44px] rounded-xl bg-black text-white"
            >
              <span>Generate</span>
            </button>
            <button
              id="downloadBtn"
              disabled
              class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 min-h-[44px] rounded-xl bg-gray-100 text-gray-800 hover:bg-gray-200"
            >
              ดาวน์โหลด
            </button>
            <button
              id="fullPreviewBtn"
              disabled
              class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 min-h-[44px] rounded-xl bg-blue-600 text-white hover:bg-blue-700"
            >
              Full preview
            </button>
          </div>
        </div>

        <div
          id="statusText"
          class="mt-3 flex items-center gap-2 text-sm hidden"
        ></div>
      </section>

      <!-- Preview Card -->
      <section class="bg-white rounded-2xl shadow overflow-hidden">
        <div class="border-b px-4 py-3 text-sm text-gray-500">ตัวอย่าง PDF</div>
        <div class="aspect-[3/2] md:aspect-[4/3] lg:aspect-[16/10]">
          <iframe
            id="pdfPreview"
            title="PDF Preview"
            class="w-full h-full"
          ></iframe>
        </div>
      </section>
    </main>

    <footer class="py-8 text-center text-xs text-gray-500">
      &copy; 2025 NO&LOW CODES
    </footer>

    <!-- Fullscreen Overlay -->
    <div id="fullOverlay" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/70" id="overlayBackdrop"></div>
      <div id="fullContainer" class="relative z-10 w-full h-full flex flex-col">
        <div
          class="flex items-center justify-between px-4 py-3 bg-black/60 text-white"
        >
          <div id="fullOverlayTitle" class="text-sm truncate">
            Full preview — Guest
          </div>
          <div class="flex items-center gap-2">
            <button
              id="downloadBtnFull"
              class="px-3 py-1.5 rounded bg-white/10 hover:bg-white/20"
            >
              ดาวน์โหลด
            </button>
            <button
              id="toggleFullscreenBtn"
              class="px-3 py-1.5 rounded bg-white/10 hover:bg-white/20"
            >
              Toggle Fullscreen
            </button>
            <button
              id="closeOverlayBtn"
              class="px-3 py-1.5 rounded bg-white text-black"
            >
              ปิด
            </button>
          </div>
        </div>
        <iframe
          title="iframe"
          id="pdfPreviewFull"
          class="w-full flex-1 bg-white"
        ></iframe>
      </div>
    </div>

    <script>
      const TEMPLATE_URL = "../cert-template.pdf";
      const FONT_URL = "../Sarabun-Regular.ttf";
      const SIGN_URL = "../sign.png";

      let state = {
        name: "Guest",
        lang: "th",
        date: "",
        eventName: "Test Event",
        pdfUrl: "",
      };

      document.addEventListener("DOMContentLoaded", () => {
        initFromURL();
        bindEvents();
        generatePDF();
      });

      function initFromURL() {
        const q = new URLSearchParams(location.search);
        state.name = (q.get("name") || "Guest").trim();
        state.lang = (q.get("lang") || "th").trim();
        state.date = (q.get("date") || "").trim();
        state.eventName = (q.get("event") || "Test Event").trim();
        if (state.lang === "th") dayjs.locale("th");
        else dayjs.locale("en");
        document.getElementById("displayName").textContent = state.name;
      }

      function bindEvents() {
        document
          .getElementById("generateBtn")
          .addEventListener("click", generatePDF);
        document
          .getElementById("downloadBtn")
          .addEventListener("click", downloadPDF);
        document
          .getElementById("fullPreviewBtn")
          .addEventListener("click", showFullPreview);
        document
          .getElementById("overlayBackdrop")
          .addEventListener("click", hideFullPreview);
        document
          .getElementById("closeOverlayBtn")
          .addEventListener("click", hideFullPreview);
        document
          .getElementById("downloadBtnFull")
          .addEventListener("click", downloadPDF);
        document
          .getElementById("toggleFullscreenBtn")
          .addEventListener("click", toggleFullscreen);
        document
          .getElementById("copyLinkBtn")
          .addEventListener("click", () =>
            copyLink("สมชาย ใจดี", "การอบรมสร้างเกียรติบัตร", "2025-01-01")
          );
        document
          .getElementById("exampleLink")
          .addEventListener("click", (e) => {
            e.preventDefault();
            applyUrl("สมชาย ใจดี", "การอบรมสร้างเกียรติบัตร", "2025-01-01");
          });
      }

      function buildUrl(name, event, date) {
        const params = new URLSearchParams(window.location.search);
        params.set("name", name);
        params.set("event", event);
        if (date) params.set("date", date);
        else params.delete("date");
        return `${location.pathname}?${params.toString()}`;
      }

      function applyUrl(name, event, date) {
        state.name = name;
        state.eventName = event;
        state.date = date;
        document.getElementById("displayName").textContent = name;
        history.replaceState(null, "", buildUrl(name, event, date));
        generatePDF();
      }

      async function copyLink(name, event, date) {
        const url = new URL(
          buildUrl(name, event, date),
          location.origin
        ).toString();
        await navigator.clipboard.writeText(url);
        alert("คัดลอกแล้ว");
      }

      async function generatePDF() {
        setStatus("กำลังสร้างไฟล์…");
        try {
          const pdfUrl = await createPdf({
            event: { name: state.eventName },
            name: state.name,
            lang: state.lang,
            date: state.date,
          });
          state.pdfUrl = pdfUrl;
          document.getElementById("pdfPreview").src = pdfUrl;
          document.getElementById("pdfPreviewFull").src = pdfUrl;
          document.getElementById("downloadBtn").disabled = false;
          document.getElementById("fullPreviewBtn").disabled = false;
          setStatus("พร้อมแสดงผล", "success");
        } catch (err) {
          console.error(err);
          setStatus("สร้างไฟล์ไม่สำเร็จ", "error");
        }
      }

      function setStatus(msg, type = "loading") {
        const el = document.getElementById("statusText");
        el.textContent = msg;
        el.classList.remove("hidden");
        el.className = "mt-3 flex items-center gap-2 text-sm";
        if (type === "success") el.classList.add("text-emerald-700");
        if (type === "error") el.classList.add("text-red-600");
      }

      function downloadPDF() {
        if (!state.pdfUrl) return;
        const a = document.createElement("a");
        a.href = state.pdfUrl;
        a.download = `Certificate - ${state.name}.pdf`;
        a.click();
      }

      function showFullPreview() {
        document.getElementById("fullOverlay").classList.remove("hidden");
        document.getElementById(
          "fullOverlayTitle"
        ).textContent = `Full preview — ${state.name}`;
      }

      function hideFullPreview() {
        document.getElementById("fullOverlay").classList.add("hidden");
      }

      async function toggleFullscreen() {
        const el = document.getElementById("fullContainer");
        if (!document.fullscreenElement) {
          await el.requestFullscreen();
        } else {
          await document.exitFullscreen();
        }
      }

      function parseDateFlexible(input) {
        if (!input) return dayjs();
        const s = input.trim();
        if (/^today$/i.test(s) || s === "วันนี้") return dayjs();
        if (/^yesterday$/i.test(s) || s === "เมื่อวาน")
          return dayjs().subtract(1, "day");
        const formats = [
          "YYYY-MM-DD",
          "DD/MM/YYYY",
          "DD-MM-YYYY",
          "YYYY/MM/DD",
          "D/M/YYYY",
          "D-M-YYYY",
        ];
        let d = dayjs(s, formats, true);
        if (!d.isValid()) {
          const parts = s.split(/[/-]/).map(Number);
          if (parts.length === 3) {
            let [a, b, c] = parts;
            if (c >= 2400) c -= 543;
            if (a > 31) d = dayjs(`${a}-${b}-${c}`, "YYYY-M-D");
            else if (c > 31) d = dayjs(`${c}-${b}-${a}`, "YYYY-M-D");
          }
        }
        return d.isValid() ? d : dayjs();
      }

      function formatDisplayDate(d, lang) {
        if (lang === "th") {
          return d.locale("th").format("D MMMM BBBB"); // ปี พ.ศ.
        } else {
          return d.locale("en").format("D MMMM YYYY"); // ปี ค.ศ.
        }
      }

      async function createPdf({ event, name, lang, date }) {
        const [pdfBytes, fontBytes, signBytes] = await Promise.all([
          fetch(TEMPLATE_URL).then((r) => r.arrayBuffer()),
          fetch(FONT_URL).then((r) => r.arrayBuffer()),
          fetch(SIGN_URL).then((r) => r.arrayBuffer()),
        ]);

        const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
        pdfDoc.registerFontkit(fontkit);
        const form = pdfDoc.getForm();
        const font = await pdfDoc.embedFont(fontBytes, { subset: true });
        const signImg = await pdfDoc.embedPng(signBytes);

        const dateObj = parseDateFlexible(date);
        const dateText = formatDisplayDate(dateObj, lang);
        const titleText =
          lang === "en" ? "Completion Certificate" : "ผ่านการอบรม";
        const contentText =
          (lang === "en" ? "Participated in " : "เข้าร่วมกิจกรรม ") +
          event.name;

        const setTextIfExists = (field, text) => {
          try {
            const tf = form.getTextField(field);
            tf.setText(text);
            tf.defaultUpdateAppearances(font);
          } catch {}
        };
        setTextIfExists("Name", name);
        setTextIfExists("Date", dateText);
        setTextIfExists("Title", titleText);
        setTextIfExists("Content", contentText);

        try {
          form.getButton("Signature").setImage(signImg);
        } catch {
          const page = pdfDoc.getPages()[0];
          page.drawImage(signImg, {
            x: page.getWidth() - 150,
            y: 60,
            width: 100,
            height: 50,
          });
        }

        form.flatten();
        const bytes = await pdfDoc.save();
        return URL.createObjectURL(
          new Blob([bytes], { type: "application/pdf" })
        );
      }
    </script>
  </body>
</html>
